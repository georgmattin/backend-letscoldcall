<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Cold Call - Voice SDK Dialer</title>
    <!-- Component CSS -->
    <link rel="stylesheet" href="components/sticky-call-button.css">
    <link rel="stylesheet" href="components/dialer-panel.css">
    <link rel="stylesheet" href="components/audio-settings.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* Dialer Container (Slide-in from right) */
        .dialer-container {
            position: fixed;
            right: -450px; /* Completely hide off-screen */
            top: 50%;
            transform: translateY(-50%);
            z-index: 1001;
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 0;
            width: 400px;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dialer-container.open {
            right: 24px; /* Slide in to visible position */
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .dialer-container {
                width: calc(100vw - 32px);
                right: 16px;
                max-height: calc(100vh - 32px);
                overflow-y: auto;
            }
        }

        @media (max-height: 600px) {
            .dialer-container {
                transform: translateY(-50%) scale(0.9);
            }
            
            .dialer-container.open {
                transform: translateY(-50%) scale(0.9);
            }
        }

        /* Backdrop Overlay */
        .dialer-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .dialer-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .dialer-header {
            padding: 16px 20px 12px 20px;
            border-bottom: 1px solid #f1f5f9;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .close-btn:hover {
            background: #f3f4f6;
        }

        .dialer-content {
            padding: 16px 20px 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Number Display */
        .number-display {
            background: #f9fafb;
            border-radius: 12px;
            padding: 12px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .number-display-content {
            text-align: center;
            flex: 1;
        }

        .clear-number-btn {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
            visibility: hidden;
        }

        .clear-number-btn.visible {
            opacity: 1;
            visibility: visible;
        }

        .clear-number-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .number-text {
            font-size: 24px;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            color: #1f2937;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-text.placeholder {
            color: #9ca3af;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            letter-spacing: normal;
        }



        /* Dialpad */
        .dialpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .dialpad-key {
            height: 56px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .dialpad-key:hover {
            background: #dbeafe;
            border-color: #bfdbfe;
        }

        .dialpad-key:active {
            transform: scale(0.95);
        }

        .key-number {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
        }



        /* Action Buttons */
        .action-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px solid #059669;
            background: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .call-btn:disabled {
            background: #d1d5db;
            border-color: #d1d5db;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .call-btn:not(:disabled):hover {
            background: #059669;
            border-color: #047857;
            transform: scale(1.05);
        }

        /* Device Selection */
        .device-selection {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .device-selection.expanded {
            max-height: 160px;
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }

        .device-section {
            margin-bottom: 12px;
        }

        .device-section:last-child {
            margin-bottom: 0;
        }

        .device-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #1f2937;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .device-select:hover {
            border-color: #d1d5db;
        }

        .device-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .device-select option {
            padding: 8px;
        }

        .device-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
            transition: background-color 0.2s;
        }

        .device-status-indicator.connected {
            background: #10b981;
        }

        .device-status-indicator.error {
            background: #ef4444;
        }

        .device-status-indicator.warning {
            background: #f59e0b;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: #ef4444;
        }

        .status-indicator.connected {
            background: #10b981;
        }

        .status-indicator.connecting {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Audio Settings Toggle */
        .audio-settings-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .audio-settings-toggle:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .audio-settings-toggle.active {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .audio-toggle-text {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .audio-toggle-icon {
            transition: transform 0.2s;
        }

        .audio-settings-toggle.active .audio-toggle-icon {
            transform: rotate(180deg);
        }

        .audio-status-dots {
            display: flex;
            gap: 4px;
        }

        .audio-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #d1d5db;
        }

        .audio-status-dot.connected {
            background: #10b981;
        }

        .audio-status-dot.error {
            background: #ef4444;
        }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
        }

        .call-controls {
            display: none;
            text-align: center;
            margin-top: 20px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: white;
        }

        .call-controls.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .call-info {
            margin-bottom: 20px;
        }

        .call-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #3498db;
        }

        .call-status {
            font-size: 16px;
            margin-bottom: 5px;
            color: #bdc3c7;
        }

        .call-timer {
            font-size: 18px;
            font-weight: bold;
            color: #2ecc71;
            font-family: 'Courier New', monospace;
        }

        .call-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: #34495e;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 80px;
        }

        .control-btn:hover {
            background: #4a6278;
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: #e74c3c;
        }

        .hangup-btn {
            background: #e74c3c;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .hangup-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }

        /* Outgoing Call Widget Styles */
        .outgoing-call-widget {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 50;
            width: 320px;
            display: block;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            pointer-events: none;
        }
        
        .outgoing-call-widget.show {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        .call-widget-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 24px;
        }
        
        .widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .widget-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .widget-status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .widget-status-text {
            font-size: 14px;
            font-weight: 500;
            color: #10b981;
        }
        
        .widget-timer {
            font-size: 12px;
            color: #6b7280;
        }
        
        .widget-contact {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .widget-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 24px;
        }
        
        .widget-avatar-text {
            color: white;
        }
        
        .widget-contact-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 4px 0;
            text-align: center;
        }
        
        .widget-contact-number {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
            text-align: center;
        }
        
        .widget-call-status {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .widget-call-status > div {
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .widget-call-status .active {
            display: flex;
        }
        
        .status-connecting {
            color: #6b7280;
        }
        
        .connecting-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #3b82f6;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .status-ringing {
            color: #3b82f6;
        }
        
        .ringing-icon {
            animation: bounce 1s infinite;
        }
        
        .status-connected {
            color: #10b981;
        }
        
        .connected-dot {
            width: 16px;
            height: 16px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .widget-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .widget-control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .widget-control-btn:hover {
            border-color: #d1d5db;
            background: #f9fafb;
        }
        
        .widget-control-btn.muted {
            background: #ef4444;
            border-color: #dc2626;
            color: white;
        }
        
        .widget-control-btn.speaker-on {
            background: #3b82f6;
            border-color: #2563eb;
            color: white;
        }
        
        .widget-hangup-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: #ef4444;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .widget-hangup-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .widget-icon {
            color: currentColor;
        }
        
        .widget-quality {
            text-align: center;
        }
        
        .widget-quality p {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }
        
        .legacy-hidden {
            display: none !important;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        /* Incoming Call Notification */
        .incoming-call-notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 999999;
            display: none;
        }

        .incoming-call-notification.active {
            display: block;
            animation: slideInFromRight 0.3s ease-out;
        }

        @keyframes slideInFromRight {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }

        .call-card {
            width: 320px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 2px solid #e5e7eb;
            padding: 24px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Header */
        .call-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .call-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-text {
            font-size: 14px;
            font-weight: 500;
            color: #3b82f6;
        }

        .dismiss-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .dismiss-btn:hover {
            color: #374151;
        }

        /* Contact Info */
        .contact-info {
            text-align: center;
            margin-bottom: 32px;
        }

        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }

        .avatar {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background: #dbeafe;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid rgba(59, 130, 246, 0.2);
            animation: pulse 2s infinite;
        }

        .avatar-text {
            font-size: 32px;
        }

        .phone-indicator {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 24px;
            height: 24px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phone-icon {
            font-size: 12px;
            animation: bounce 1s infinite;
        }

        .contact-name {
            font-size: 20px;
            font-weight: bold;
            margin: 0 0 4px 0;
            color: #111827;
        }

        .contact-number {
            font-size: 16px;
            color: #6b7280;
            margin: 0 0 8px 0;
        }

        .contact-label {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Ringing Animation */
        .ringing-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            color: #3b82f6;
            font-size: 14px;
        }

        .bounce-dots {
            display: flex;
            gap: 4px;
        }

        .bounce-dot {
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .bounce-dot:nth-child(1) { animation-delay: -0.32s; }
        .bounce-dot:nth-child(2) { animation-delay: -0.16s; }
        .bounce-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 24px;
        }

        .action-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px solid;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .decline-btn {
            border-color: #fecaca;
            color: #ef4444;
        }

        .decline-btn:hover {
            background: #fef2f2;
            border-color: #fca5a5;
        }

        .message-btn {
            border-color: #e5e7eb;
            color: #6b7280;
        }

        .message-btn:hover {
            background: #f9fafb;
        }

        .accept-btn {
            background: #10b981;
            border-color: #10b981;
            color: white;
            animation: pulse 2s infinite;
        }

        .accept-btn:hover {
            background: #059669;
            border-color: #059669;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            font-size: 12px;
        }

        .quick-action {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            text-decoration: none;
        }

        .quick-action:hover {
            color: #374151;
        }

        .separator {
            color: #d1d5db;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .volume-indicator {
            margin-top: 15px;
        }

        .volume-label {
            font-size: 14px;
            margin-bottom: 8px;
            color: #bdc3c7;
        }

        .volume-bar {
            background: #2c3e50;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid #34495e;
        }

        .volume-level {
            background: linear-gradient(90deg, #2ecc71, #f39c12, #e74c3c);
            height: 100%;
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 3px;
        }

        .quick-numbers {
            margin-bottom: 15px;
        }

        .quick-numbers button {
            background: #17a2b8;
            color: white;
            margin: 2px;
            padding: 8px 12px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .tips {
            text-align: center;
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
        }

        .audio-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .audio-controls h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }

        .device-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
            font-size: 14px;
        }

        .device-select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background: white;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .device-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .test-button {
            padding: 6px 12px;
            border: 1px solid #007bff;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .test-button:hover {
            background: #0056b3;
            border-color: #0056b3;
        }

        .test-button:active {
            background: #004085;
        }

        /* Contacts Table on Main Page */
        .contacts-table-container {
            max-width: 800px;
            margin: 0 auto 40px auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .contacts-table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            color: white;
        }

        .contacts-table-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .contacts-table {
            padding: 0;
        }

        .contacts-table-row {
            display: grid;
            grid-template-columns: 60px 1fr 200px 120px;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s;
        }

        .contacts-table-row:hover {
            background: #f9fafb;
        }

        .contacts-table-row:last-child {
            border-bottom: none;
        }

        .contact-table-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .contact-table-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .contact-table-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .contact-table-company {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }

        .contact-table-phone {
            font-size: 16px;
            color: #374151;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .contact-table-call-btn {
            background: #10b981;
            border: 2px solid #059669;
            border-radius: 8px;
            color: white;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 100px;
        }

        .contact-table-call-btn:hover {
            background: #059669;
            border-color: #047857;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .contact-table-call-btn:active {
            transform: translateY(0);
        }

        /* Mobile responsiveness for table */
        @media (max-width: 768px) {
            .contacts-table-container {
                margin: 0 16px 40px 16px;
            }
            
            .contacts-table-row {
                grid-template-columns: 1fr;
                gap: 12px;
                text-align: center;
                padding: 20px;
            }
            
            .contact-table-avatar {
                justify-self: center;
            }
            
            .contact-table-phone {
                font-size: 14px;
            }
        }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <!-- Contacts Table on Main Page -->
    <div class="contacts-table-container">
        <div class="contacts-table-header">
            <h2 class="contacts-table-title">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Kontaktid
            </h2>
        </div>
        
        <div class="contacts-table" id="contactsTable">
            <!-- Contacts will be populated by JavaScript -->
        </div>
    </div>

    <!-- Sticky Call Button will be created by the component -->

    <!-- Backdrop -->
    <div class="dialer-backdrop" id="dialerBackdrop" onclick="closeDialer()"></div>

    <!-- Dialer Container -->
    <div class="dialer-container" id="dialerContainer">
        <div class="dialer-header">
            <div class="header-content">
                <h2 class="header-title">Helistaja</h2>
                <button class="close-btn" onclick="closeDialer()" title="Sulge">‚úï</button>
            </div>
        </div>

        <div class="dialer-content">
            <div class="device-status" id="deviceStatus">
                <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">√úhendamine...</span>
        </div>

            <div class="status-message" id="statusMessage" style="display: none;"></div>

            <!-- Dialer Panel Component will be inserted here -->
            <div id="dialerPanelContainer"></div>

            <!-- Audio Settings Component will be inserted here -->
            <div id="audioSettingsContainer"></div>





        </div>



        <!-- Legacy Active Call Interface (hidden) -->
        <div class="call-controls legacy-hidden" id="callControls">
            <div class="call-info">
                <div class="call-number" id="callNumber">+37256272798</div>
                <div class="call-status" id="callStatusText">√úhendamine...</div>
                <div class="call-timer" id="callTimer">00:00</div>
            </div>
            
            <div class="call-buttons">
                <button id="muteBtn" onclick="toggleMute()" class="control-btn mute-btn">
                    <span id="muteIcon">üé§</span>
                    <span id="muteText">Vaigista</span>
                </button>
                <button id="hangupBtn" onclick="hangupCall()" class="hangup-btn">
                    üìû L√µpeta
                </button>
                <button id="speakerBtn" onclick="toggleSpeaker()" class="control-btn speaker-btn">
                    <span id="speakerIcon">üîä</span>
                    <span id="speakerText">K√µlar</span>
                </button>
            </div>
               
            <div class="volume-indicator" id="volumeIndicator">
                <div class="volume-label">Heli tase:</div>
                <div class="volume-bar">
                    <div class="volume-level" id="volumeLevel"></div>
            </div>
            </div>
        </div>
    </div>

    <!-- Incoming Call Popup (Outside dialer container) -->
    <div class="incoming-call-notification" id="incomingCallPopup">
        <div class="call-card">
            <!-- Header -->
            <div class="call-header">
                <div class="call-status">
                    <div class="status-dot"></div>
                    <span class="status-text">Sissetulev k√µne</span>
            </div>
                <button class="dismiss-btn" onclick="declineIncomingCall()">‚úï</button>
            </div>
                
            <!-- Contact Info -->
            <div class="contact-info">
                <div class="avatar-container">
                    <div class="avatar">
                        <span class="avatar-text">üìû</span>
            </div>
                    <div class="phone-indicator">
                        <div class="phone-icon">üì±</div>
                    </div>
                </div>
                <h3 class="contact-name">Tundmatu helistaja</h3>
                <p class="contact-number" id="incomingCallerNumber">+37256272798</p>
                <span class="contact-label">Sissetulev k√µne</span>
            </div>

            <!-- Ringing Animation -->
            <div class="ringing-status">
                <div class="bounce-dots">
                    <div class="bounce-dot"></div>
                    <div class="bounce-dot"></div>
                    <div class="bounce-dot"></div>
            </div>
                <span class="ringing-text">Helistab...</span>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn decline-btn" onclick="declineIncomingCall()" title="Keeldu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 5.5C3 14.06 9.94 21 18.5 21c.386 0 .77-.014 1.148-.042l-1.85-1.85A8.5 8.5 0 0 1 5.85 7.15L4 5.5Z"/>
                        <path d="M22 2 2 22"/>
                        <path d="M18.5 3C14.36 3 11 6.36 11 10.5v1l9 9c.028-.378.042-.762.042-1.148C20.042 11.94 22 3 22 3Z"/>
                    </svg>
                </button>

                <button class="action-btn message-btn" onclick="quickMessage()" title="Kiire s√µnum">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                </button>

                <button class="action-btn accept-btn" onclick="acceptIncomingCall()" title="V√µta vastu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                </button>
            </div>
              
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action">Kiire vastus</button>
                <span class="separator">‚Ä¢</span>
                <button class="quick-action">Blokeeri number</button>
            </div>
            </div>
            </div>

    <!-- Outgoing Call Widget (Outside dialer container) -->
    <div class="outgoing-call-widget" id="outgoingCallWidget">
        <div class="call-widget-card">
            <!-- Header -->
            <div class="widget-header">
                <div class="widget-status">
                    <div class="widget-status-dot"></div>
                    <span class="widget-status-text" id="callTypeText">V√§ljaminev k√µne</span>
            </div>
                <div class="widget-timer" id="widgetTimer">√úhendamine...</div>
        </div>

            <!-- Contact Info -->
            <div class="widget-contact">
                <div class="widget-avatar">
                    <span class="widget-avatar-text">üë§</span>
                </div>
                <h3 class="widget-contact-name" id="widgetContactName">Tundmatu number</h3>
                <p class="widget-contact-number" id="widgetContactNumber">+37256272798</p>
        </div>

            <!-- Call Status -->
            <div class="widget-call-status" id="widgetCallStatus">
                <div class="status-connecting" id="statusConnecting">
                    <div class="connecting-spinner"></div>
                    <span>√úhendamine...</span>
                </div>
                <div class="status-ringing" id="statusRinging">
                    <svg class="ringing-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                    <span>Helistamine...</span>
                </div>
                <div class="status-connected" id="statusConnected">
                    <div class="connected-dot"></div>
                    <span>K√µne k√§ib</span>
                </div>
        </div>

            <!-- Call Controls -->
            <div class="widget-controls">
                <button class="widget-control-btn" id="widgetMuteBtn" onclick="widgetToggleMute()" title="Mikrofon">
                    <svg class="widget-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
            </button>

                <button class="widget-hangup-btn" onclick="widgetHangupCall()" title="L√µpeta k√µne">
                    <svg class="widget-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 5.5C3 14.06 9.94 21 18.5 21c.386 0 .77-.014 1.148-.042l-1.85-1.85A8.5 8.5 0 0 1 5.85 7.15L4 5.5Z"/>
                        <path d="M22 2 2 22"/>
                        <path d="M18.5 3C14.36 3 11 6.36 11 10.5v1l9 9c.028-.378.042-.762.042-1.148C20.042 11.94 22 3 22 3Z"/>
                    </svg>
                </button>

                <button class="widget-control-btn" id="widgetSpeakerBtn" onclick="widgetToggleSpeaker()" title="K√µlar">
                    <svg class="widget-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5,6 9,2 9,2 15,6 15,11 19"/>
                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                    </svg>
            </button>
            </div>

            <!-- Quality Info -->
            <div class="widget-quality">
                <p>Kvaliteet: HD Audio</p>
            </div>
        </div>
    </div>

    <!-- Twilio Voice SDK -->
    <script src="twilio.min.js"></script>
    
    <!-- Component Scripts -->
    <script src="components/sticky-call-button.js"></script>
    <script src="components/dialer-panel.js"></script>
    <script src="components/audio-settings.js"></script>
    
    <script>
        // Import Device from Twilio Voice SDK
        const { Device } = Twilio;
        
        let currentNumber = '';
        let device = null;
        let currentCall = null;
        let accessToken = null;
        let availableInputDevices = [];
        let availableOutputDevices = [];
        let selectedInputDevice = null;
        let selectedOutputDevice = null;

        // Initialize the application
        async function initializeApp() {
            try {
                // Wait for Twilio SDK to load
                if (typeof Twilio === 'undefined') {
                    showStatus('‚è≥ Ootan Twilio SDK laadimist...', 'info');
                    await waitForTwilio();
                }

                showStatus('√úhendamine Twilio Voice SDK-ga...', 'info');
                updateDeviceStatus('connecting', '√úhendamine...');

                // Request notification permission
                await requestNotificationPermission();

                // First, request microphone permission explicitly
                showStatus('üé§ K√ºsin mikrofoni luba...', 'info');
                await requestMicrophonePermission();

                // Get access token
                const response = await fetch('/api/access-token');
                const data = await response.json();
                
                if (!response.ok || !data.token) {
                    const errorMsg = data.error || data.details || 'Token generation failed';
                    if (errorMsg.includes('not configured')) {
                        throw new Error('Twilio pole konfigureeritud! Palun mine admin lehele: /admin');
                    }
                    throw new Error(errorMsg);
                }

                accessToken = data.token;
                console.log('Access token received for identity:', data.identity);

                // Initialize Twilio Device
                await initializeTwilioDevice();

                // Initialize UI state
                updateActionButtons();

            } catch (error) {
                console.error('Initialization error:', error);
                const errorMessage = error && error.message ? error.message : 'Tundmatu viga';
                showStatus('Viga: ' + errorMessage, 'error');
                updateDeviceStatus('disconnected', '√úhendus eba√µnnestus');
            }
        }

        // Wait for Twilio SDK to load
        function waitForTwilio() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds
                
                const checkTwilio = () => {
                    attempts++;
                    if (typeof Twilio !== 'undefined' && Twilio.Device) {
                        console.log('Twilio SDK loaded successfully');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Twilio SDK ei laadunud. Kontrolli interneti√ºhendust.'));
                    } else {
                        setTimeout(checkTwilio, 100);
                    }
                };
                
                checkTwilio();
            });
        }

        // Request notification permission
        async function requestNotificationPermission() {
            try {
                console.log('üîî Requesting notification permission...');
                
                if ('Notification' in window) {
                    // Check current permission first
                    console.log('Current notification permission:', Notification.permission);
                    
                    const permission = await Notification.requestPermission();
                    notificationPermissionGranted = permission === 'granted';
                    
                    console.log('New notification permission:', permission);
                    console.log('notificationPermissionGranted variable:', notificationPermissionGranted);
                    
                    if (notificationPermissionGranted) {
                        console.log('‚úÖ Notification permission granted');
                        showStatus('üîî Teavituste luba saadud!', 'success');
                        
                        // Test notification to make sure it works
                        setTimeout(() => {
                            try {
                                console.log('üß™ Creating test notification...');
                                const testNotification = new Notification('‚úÖ Notifikatsioonid t√∂√∂tavad!', {
                                    body: 'Sa saad n√º√ºd sissetulevate k√µnede kohta notifikatsioone.',
                                    icon: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                                            <circle cx="50" cy="50" r="45" fill="#2ecc71"/>
                                            <circle cx="50" cy="50" r="25" fill="white"/>
                                            <path d="M35 50 L45 60 L65 40" stroke="#2ecc71" stroke-width="4" fill="none"/>
                                        </svg>
                                    `),
                                    tag: 'test-notification'
                                });
                                
                                console.log('‚úÖ Test notification created successfully');
                                setTimeout(() => testNotification.close(), 3000);
                            } catch (testError) {
                                console.error('‚ùå Test notification failed:', testError);
                            }
                        }, 1000);
                        
                    } else {
                        console.log('‚ùå Notification permission denied');
                        showStatus('‚ö†Ô∏è Teavituste luba keelatud - sissetulevate k√µnede notifikatsioonid ei t√∂√∂ta', 'warning');
                    }
                } else {
                    console.log('‚ùå Notifications not supported');
                    showStatus('‚ö†Ô∏è Brauser ei toeta teavitusi', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Error requesting notification permission:', error);
                showStatus('‚ùå Notifikatsioonide seadistamine eba√µnnestus', 'error');
            }
        }

        // Check if user is currently viewing the dialer page
        function isPageVisible() {
            return !document.hidden && document.visibilityState === 'visible';
        }

        // Show push notification for incoming call
        function showIncomingCallNotification(callerNumber) {
            console.log('üîî showIncomingCallNotification called with:', callerNumber);
            console.log('üîî notificationPermissionGranted:', notificationPermissionGranted);
            console.log('üîî Notification.permission:', Notification.permission);
            
            if (!notificationPermissionGranted) {
                console.log('‚ùå Notification permission not granted - cannot show notification');
                return; // Don't show notification if no permission
            }
            
            // Always show notification for incoming calls (both when page visible and hidden)
            console.log('üìû Attempting to create notification for incoming call from:', callerNumber);

            try {
                const notification = new Notification('üìû Sissetulev k√µne', {
                body: `K√µne numbrilt: ${callerNumber || 'Tundmatu number'}\n\nKliki notifikatsioonile, et minna tagasi dialeri lehele.`,
                icon: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="#2ecc71"/>
                        <circle cx="50" cy="50" r="25" fill="white"/>
                        <rect x="35" y="35" width="30" height="30" rx="5" fill="#2ecc71"/>
                    </svg>
                `),
                tag: 'incoming-call', // Only one notification at a time
                requireInteraction: true, // Stay visible until user interacts
                silent: false // Allow sound
            });

            // Handle notification click
            notification.onclick = function() {
                window.focus(); // Focus the browser window
                notification.close();
                
                // If popup is still active, focus on it
                const popup = document.getElementById('incomingCallPopup');
                if (popup && popup.classList.contains('active')) {
                    // Auto-focus on accept button
                    const acceptBtn = document.getElementById('acceptCallBtn');
                    if (acceptBtn) {
                        acceptBtn.focus();
                    }
                }
            };

            // Auto close notification after 30 seconds
            setTimeout(() => {
                notification.close();
            }, 30000);

                // Store reference to current notification
                currentNotification = notification;
                
                console.log('‚úÖ Notification created successfully:', notification);
                return notification;
                
            } catch (notificationError) {
                console.error('‚ùå Failed to create notification:', notificationError);
                return null;
            }
        }

        // Request microphone permission explicitly
        async function requestMicrophonePermission() {
            try {
                showStatus('üé§ Palun luba mikrofoni kasutamine brauseris!', 'info');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                // Stop the stream immediately - we just needed permission
                stream.getTracks().forEach(track => track.stop());
                
                showStatus('‚úÖ Mikrofoni luba saadud!', 'success');
                console.log('Microphone permission granted');
                
                // Hide manual microphone permission button (if exists)
                const micControls = document.getElementById('microphoneControls');
                if (micControls) {
                    micControls.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Microphone permission error:', error);
                
                let errorMessage = 'Mikrofoni luba on vajalik k√µnede tegemiseks!';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = '‚ùå Mikrofoni luba keelatud! Palun luba mikrofon brauseri seadetes.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = '‚ùå Mikrofoni ei leitud! Kontrolli, kas mikrofon on √ºhendatud.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = '‚ùå Brauser ei toeta mikrofoni! Kasuta Chrome, Firefox v√µi Edge.';
                }
                
                showStatus(errorMessage, 'error');
                updateDeviceStatus('disconnected', 'Mikrofoni luba puudub');
                
                // Show manual microphone permission button
                document.getElementById('microphoneControls').style.display = 'block';
                
                throw error;
            }
        }

        async function initializeTwilioDevice() {
            try {
                showStatus('üîß Seadistan Twilio Voice SDK...', 'info');

                // Resume AudioContext on user interaction to prevent browser warnings
                const resumeAudioContext = () => {
                    console.log('üîä Resuming AudioContext...');
                    try {
                    if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            console.log('üîä AudioContext state:', audioContext.state);
                        if (audioContext.state === 'suspended') {
                                audioContext.resume().then(() => {
                                    console.log('‚úÖ AudioContext resumed successfully');
                                }).catch(error => {
                                    console.error('‚ùå Failed to resume AudioContext:', error);
                                });
                            }
                        }
                        
                        // Also try to play a silent audio to unlock audio
                        const audioElement = document.createElement('audio');
                        audioElement.muted = true;
                        audioElement.play().then(() => {
                            console.log('‚úÖ Audio unlocked via silent play');
                        }).catch(error => {
                            console.log('‚ö†Ô∏è Silent audio play failed (this is often expected):', error);
                        });
                        
                    } catch (error) {
                        console.error('‚ùå Error resuming audio:', error);
                    }
                };
                
                // Add multiple listeners to resume audio context
                document.addEventListener('click', resumeAudioContext, { once: true });
                document.addEventListener('touchstart', resumeAudioContext, { once: true });
                document.addEventListener('keydown', resumeAudioContext, { once: true });

                // Create Twilio Device with access token (Voice SDK 2.x)
                device = new Device(accessToken, {
                    logLevel: 'debug',
                    edge: 'sydney', // Use closest edge location
                    enableRingingState: true,
                    allowIncomingWhileBusy: true
                });
                
                // Device event handlers
                device.on('registered', function() {
                    console.log('Twilio Device is registered and ready');
                    updateDeviceStatus('connected', '√úhendatud - Valmis k√µnedeks');
                    showStatus('‚úÖ Voice SDK on valmis! Saad n√º√ºd helistada mikrofoniga.', 'success');
                    
                    // Set the Twilio device for the audio settings component
                    if (audioSettings) {
                        audioSettings.setTwilioDevice(device);
                        console.log('Audio settings component updated with Twilio device');
                    }
                });

                device.on('error', function(error) {
                    console.error('Device error:', error);
                    showStatus('Seadme viga: ' + error.message, 'error');
                    updateDeviceStatus('disconnected', 'Viga');
                });

                device.on('incoming', function(call) {
                    console.log('üö® === INCOMING CALL EVENT ===');
                    console.log('üìû Incoming call from:', call.parameters.From);
                    console.log('üìû Call object:', call);
                    console.log('üìû notificationPermissionGranted:', notificationPermissionGranted);
                    console.log('üìû Current Notification.permission:', Notification.permission);
                    console.log('üìû Document visibility:', document.visibilityState);
                    console.log('üìû Document hidden:', document.hidden);
                    
                    showStatus('üìû Sissetulev k√µne: ' + call.parameters.From, 'info');
                    
                    // Store incoming call
                    incomingCall = call;
                    console.log('üìû Stored incoming call:', incomingCall);
                    
                    // Always try to show push notification for debugging
                    console.log('üîî === STARTING NOTIFICATION ===');
                    showIncomingCallNotification(call.parameters.From);
                    console.log('üîî === NOTIFICATION ATTEMPT COMPLETE ===');
                    
                    // Show incoming call popup
                    console.log('üîî === STARTING POPUP ===');
                    showIncomingCallPopup(call.parameters.From);
                    console.log('üîî === POPUP ATTEMPT COMPLETE ===');
                    
                    // Set up call event handlers for incoming call
                    call.on('accept', function() {
                        console.log('Incoming call accepted');
                        hideIncomingCallPopup();
                    currentCall = call;
                    
                        // Widget is already shown by acceptIncomingCall function
                        // Just update the status to connected if not already
                        if (widgetCallStatus !== 'connected') {
                            widgetCallStatus = 'connected';
                            updateWidgetCallStatus();
                            startWidgetCallTimer();
                        }
                        
                        showStatus('üìû Sissetulev k√µne vastu v√µetud!', 'success');
                        
                        // Keep legacy controls hidden since we're using widget
                        // showCallControls(true, call.parameters.From);
                        // startCallTimer();
                        // document.getElementById('volumeIndicator').classList.add('active');
                        // startVolumeMonitoring();
                    });

                    call.on('disconnect', function() {
                        console.log('Incoming call disconnected');
                        stopRingtone(); // Stop ringtone
                        hideIncomingCallPopup();
                        hideOutgoingCallWidget(); // Hide widget
                        currentCall = null;
                        incomingCall = null;
                        showCallControls(false);
                        showStatus('Sissetulev k√µne l√µpetatud', 'info');
                        document.getElementById('volumeIndicator').classList.remove('active');
                        stopVolumeMonitoring();
                        stopCallTimer();
                    });

                    call.on('reject', function() {
                        console.log('Incoming call rejected');
                        stopRingtone(); // Stop ringtone
                        hideIncomingCallPopup();
                        hideOutgoingCallWidget(); // Hide widget if it was shown
                        incomingCall = null;
                        showStatus('Sissetulev k√µne tagasi l√ºkatud', 'info');
                    });

                    call.on('cancel', function() {
                        console.log('Incoming call cancelled');
                        stopRingtone(); // Stop ringtone
                        hideIncomingCallPopup();
                        hideOutgoingCallWidget(); // Hide widget if it was shown
                        incomingCall = null;
                        showStatus('Sissetulev k√µne katkestatud', 'info');
                    });
                    
                    // NO auto-accept - wait for user interaction
                });

                // Register the device
                await device.register();

                // Audio devices will be loaded by the audio-settings component

                // Populate contacts list
                populateContacts();

            } catch (error) {
                console.error('Device setup error:', error);
                const errorMessage = error && error.message ? error.message : 'Tundmatu viga';
                showStatus('Seadme seadistamine eba√µnnestus: ' + errorMessage, 'error');
                updateDeviceStatus('disconnected', 'Seadistamine eba√µnnestus');
            }
        }

        // Audio device loading is now handled by audio-settings component

        // Audio device functions are now handled by audio-settings component

        // Legacy functions - now delegate to dialer panel component
        function addDigit(digit) {
            if (dialerPanel) {
                dialerPanel.addDigit(digit);
            } else {
                // Fallback for backward compatibility
                if (currentNumber.length < 20) {
                    // Play DTMF tone using dialer panel's generator if available
                    if (dialerPanel && dialerPanel.dtmfGenerator) {
                        dialerPanel.dtmfGenerator.playTone(digit);
                    }
                    
                    if (digit === '0' && currentNumber === '') {
                        currentNumber = '+';
                    } else if (digit === '*' && currentNumber === '') {
                        currentNumber = '+372';
                    } else {
                        currentNumber += digit;
                    }
                    updateDisplay();
                    updateActionButtons();
                }
            }
        }

        function clearNumber() {
            if (dialerPanel) {
                dialerPanel.clearNumber();
            } else {
                // Fallback for backward compatibility
                currentNumber = '';
                updateDisplay();
                updateActionButtons();
            }
        }

        function setNumber(number) {
            if (dialerPanel) {
                dialerPanel.setNumber(number);
            } else {
                // Fallback for backward compatibility
                currentNumber = number;
                updateDisplay();
                updateActionButtons();
            }
        }

        function updateDisplay() {
            // This function is now handled by the dialer panel component
            // Keep for backward compatibility only
            const display = document.getElementById('phoneDisplay');
            const clearBtn = document.getElementById('clearNumberBtn');
            
            if (display && clearBtn) {
                if (currentNumber.length === 0) {
                    display.textContent = 'Sisesta number';
                    display.className = 'placeholder';
                    clearBtn.classList.remove('visible');
                } else {
                    display.textContent = formatPhoneNumber(currentNumber);
                    display.className = '';
                    clearBtn.classList.add('visible');
                }
            }
        }

        function formatPhoneNumber(num) {
            // Simple Estonian phone number formatting
            if (num.startsWith('+372')) {
                const cleaned = num.replace(/\D/g, '');
                if (cleaned.length >= 7) {
                    return `+372 ${cleaned.slice(3, 7)} ${cleaned.slice(7)}`;
                }
            }
            return num;
        }

        function updateActionButtons() {
            // This function is now handled by the dialer panel component
            // Keep for backward compatibility only
            const callBtn = document.getElementById('callBtn');
            
            const hasNumber = currentNumber.trim().length > 0;
            
            if (callBtn) callBtn.disabled = !hasNumber;
        }







        async function makeCall() {
            // Get current number from dialer panel component or fallback to global variable
            const phoneNumber = dialerPanel ? dialerPanel.getNumber() : currentNumber;
            
            if (phoneNumber.length < 3) {
                showStatus('Palun sisesta kehtiv telefoninumber!', 'error');
                return;
            }

            if (!phoneNumber.startsWith('+')) {
                showStatus('‚ö†Ô∏è Number peab algama + m√§rgiga (nt +37256272798)', 'error');
                return;
            }

            if (currentCall) {
                showStatus('K√µne on juba k√§imas!', 'error');
                return;
            }

            // Use Voice SDK for microphone audio
            if (device && device.state === 'registered') {
                try {
                    showStatus('üìû Helistamine mikrofoniga...', 'info');
                    
                    // Close dialer when call starts
                    closeDialer();
                    
                    // Show outgoing call widget  
                    // Check if number matches a contact
                    const contact = sampleContacts.find(c => c.phone === phoneNumber);
                    const contactName = contact ? contact.name : null;
                    
                    showOutgoingCallWidget(phoneNumber, contactName);
                    
                    // Make call using the enhanced function
                    await makeCallToNumber(phoneNumber, contactName);

                } catch (error) {
                    console.error('Voice SDK error:', error);
                    showStatus('‚ùå Voice SDK viga: ' + error.message, 'error');
                    hideOutgoingCallWidget();
                }
            } else {
                showStatus('‚ùå Voice SDK pole valmis! Oota registreerimist...', 'error');
            }
        }

        // Create ringtone using Web Audio API
        function createRingtone() {
            try {
                console.log('üîä Creating ringtone...');
                
                // Create audio context
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Resume audio context if suspended
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                // Create ringtone function
                const playRingtone = () => {
                    try {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        // Ringtone pattern: 440Hz for 1 second, pause 0.5 seconds
                        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(880, audioContext.currentTime + 0.5);
                        oscillator.frequency.setValueAtTime(440, audioContext.currentTime + 1);
                        
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 1);
                        
                        console.log('üîä Ringtone beep played');
                    } catch (error) {
                        console.error('‚ùå Failed to play ringtone beep:', error);
                    }
                };
                
                return playRingtone;
                
            } catch (error) {
                console.error('‚ùå Failed to create ringtone:', error);
                return null;
            }
        }

        // Start playing ringtone
        function startRingtone() {
            console.log('üîä Starting ringtone...');
            
            try {
                // Stop any existing ringtone
                stopRingtone();
                
                // Method 1: Try Twilio built-in ringtone first
                if (device && device.audio && device.audio.incoming) {
                    try {
                        device.audio.incoming(true);
                        console.log('‚úÖ Twilio ringtone started');
                    } catch (error) {
                        console.log('‚ö†Ô∏è Twilio ringtone failed:', error);
                    }
                }
                
                // Method 2: Use our custom ringtone as backup
                const playRingtone = createRingtone();
                if (playRingtone) {
                    // Play immediately
                    playRingtone();
                    
                    // Set interval to repeat every 2 seconds
                    ringtoneInterval = setInterval(() => {
                        playRingtone();
                    }, 2000);
                    
                    console.log('‚úÖ Custom ringtone started');
                }
                
                // Method 3: Try HTML5 audio with generated tone
                try {
                    ringtoneAudio = new Audio();
                    ringtoneAudio.loop = true;
                    ringtoneAudio.volume = 0.3;
                    
                    // Create a simple beep sound data URL
                    const beepSound = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwMZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAZCTuRz/PVfCsEKGxZ9+KSPggVXKzs4ahYFgFCmODrxGMbCDaP0fPTfikGKjuPz/PZgCkEKGxb9+OTOwkUUqfj8r5iJAg1jdXpqmISCEyewOpkGgd2gNfnpGJr=';
                    ringtoneAudio.src = beepSound;
                    
                    ringtoneAudio.play().then(() => {
                        console.log('‚úÖ HTML5 ringtone started');
                    }).catch(error => {
                        console.log('‚ö†Ô∏è HTML5 ringtone failed:', error);
                    });
                    
                } catch (error) {
                    console.log('‚ö†Ô∏è HTML5 audio ringtone failed:', error);
                }
                
            } catch (error) {
                console.error('‚ùå Failed to start ringtone:', error);
            }
        }

        // Stop playing ringtone
        function stopRingtone() {
            console.log('üîá Stopping ringtone...');
            
            try {
                // Stop Twilio ringtone
                if (device && device.audio && device.audio.incoming) {
                    try {
                        device.audio.incoming(false);
                        console.log('‚úÖ Twilio ringtone stopped');
                    } catch (error) {
                        console.log('‚ö†Ô∏è Failed to stop Twilio ringtone:', error);
                    }
                }
                
                // Stop custom ringtone interval
                if (ringtoneInterval) {
                    clearInterval(ringtoneInterval);
                    ringtoneInterval = null;
                    console.log('‚úÖ Custom ringtone stopped');
                }
                
                // Stop HTML5 audio
                if (ringtoneAudio) {
                    ringtoneAudio.pause();
                    ringtoneAudio.currentTime = 0;
                    ringtoneAudio = null;
                    console.log('‚úÖ HTML5 ringtone stopped');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to stop ringtone:', error);
            }
        }

        // Global variables for call management
        let callStartTime = null;
        let callTimerInterval = null;
        let isMuted = false;
        let isSpeakerOn = false;
        let incomingCall = null; // Store incoming call separately
        let notificationPermissionGranted = false;
        let currentNotification = null; // Store current notification
        let ringtoneAudio = null; // Store ringtone audio element
        let ringtoneInterval = null; // Store ringtone interval

        function hangupCall() {
            if (currentCall) {
                currentCall.disconnect();
                currentCall = null;
                showCallControls(false);
                showStatus('K√µne l√µpetatud', 'info');
                stopCallTimer();
            }
        }

        function toggleMute() {
            if (currentCall) {
                if (isMuted) {
                    currentCall.mute(false);
                    isMuted = false;
                    document.getElementById('muteIcon').textContent = 'üé§';
                    document.getElementById('muteText').textContent = 'Vaigista';
                    document.getElementById('muteBtn').classList.remove('active');
                    showStatus('Mikrofon sisse l√ºlitatud', 'success');
                } else {
                    currentCall.mute(true);
                    isMuted = true;
                    document.getElementById('muteIcon').textContent = 'üîá';
                    document.getElementById('muteText').textContent = 'Valjuks';
                    document.getElementById('muteBtn').classList.add('active');
                    showStatus('Mikrofon v√§lja l√ºlitatud', 'info');
                }
            }
        }

        function toggleSpeaker() {
            // This is a placeholder - actual speaker toggle would require different implementation
            isSpeakerOn = !isSpeakerOn;
            
            if (isSpeakerOn) {
                document.getElementById('speakerIcon').textContent = 'üì¢';
                document.getElementById('speakerText').textContent = 'K√µrva';
                document.getElementById('speakerBtn').classList.add('active');
                showStatus('K√µlar sisse l√ºlitatud', 'success');
            } else {
                document.getElementById('speakerIcon').textContent = 'üîä';
                document.getElementById('speakerText').textContent = 'K√µlar';
                document.getElementById('speakerBtn').classList.remove('active');
                showStatus('K√µlar v√§lja l√ºlitatud', 'info');
            }
        }

        function showCallControls(show, phoneNumber = '') {
            const controls = document.getElementById('callControls');
            const callBtn = document.getElementById('callBtn');
            
            if (show) {
                controls.classList.add('active');
                callBtn.disabled = true;
                
                // Update call info
                document.getElementById('callNumber').textContent = phoneNumber || currentNumber;
                document.getElementById('callStatusText').textContent = '√úhendamine...';
                
                // Reset states
                isMuted = false;
                isSpeakerOn = false;
                document.getElementById('muteBtn').classList.remove('active');
                document.getElementById('speakerBtn').classList.remove('active');
                document.getElementById('muteIcon').textContent = 'üé§';
                document.getElementById('muteText').textContent = 'Vaigista';
                document.getElementById('speakerIcon').textContent = 'üîä';
                document.getElementById('speakerText').textContent = 'K√µlar';
            } else {
                controls.classList.remove('active');
                callBtn.disabled = false;
                stopCallTimer();
            }
        }

        function startCallTimer() {
            callStartTime = new Date();
            callTimerInterval = setInterval(() => {
                const elapsed = new Date() - callStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('callTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopCallTimer() {
            if (callTimerInterval) {
                clearInterval(callTimerInterval);
                callTimerInterval = null;
            }
            document.getElementById('callTimer').textContent = '00:00';
        }

        // Incoming call popup functions
        function showIncomingCallPopup(callerNumber) {
            console.log('üîî showIncomingCallPopup called with:', callerNumber);
            
            const popup = document.getElementById('incomingCallPopup');
            const callerNumberEl = document.getElementById('incomingCallerNumber');
            
            console.log('üîî Popup element found:', popup);
            console.log('üîî Caller number element found:', callerNumberEl);
            
            if (!popup) {
                console.error('‚ùå incomingCallPopup element not found!');
                return;
            }
            
            if (!callerNumberEl) {
                console.error('‚ùå incomingCallerNumber element not found!');
                return;
            }
            
            // Hide sticky button during incoming call
            if (stickyCallBtn) {
                stickyCallBtn.hide();
            }
            
            // Close dialer if open
            if (isDialerOpen) {
                closeDialer();
            }
            
            // Update caller number
            callerNumberEl.textContent = callerNumber || 'Tundmatu number';
            
            // Show popup with slide-in animation
            popup.classList.add('active');
            popup.style.display = 'block';
            
            console.log('üîî New popup notification shown at bottom-right');
            
            // Start ringtone using our multi-method approach
            startRingtone();
            
            // Auto-dismiss after 30 seconds (like in the React component)
            setTimeout(() => {
                if (popup.classList.contains('active')) {
                    console.log('üîî Auto-dismissing popup after 30 seconds');
                    declineIncomingCall();
                }
            }, 30000);
        }

        function hideIncomingCallPopup() {
            console.log('üîî Hiding incoming call notification...');
            
            const popup = document.getElementById('incomingCallPopup');
            if (!popup) {
                console.error('‚ùå Popup element not found');
                return;
            }
            
            // Remove active class and hide
            popup.classList.remove('active');
            popup.style.display = 'none';
            
            // Show sticky button again (unless call is active)
            const widget = document.getElementById('outgoingCallWidget');
            if (stickyCallBtn && (!widget || !widget.classList.contains('show'))) {
                stickyCallBtn.show();
            }
            
            console.log('üîî Popup notification hidden');
            
            // Close notification if exists
            if (currentNotification) {
                currentNotification.close();
                currentNotification = null;
            }
            
            // Stop all ringtones
            stopRingtone();
        }

        function acceptIncomingCall() {
            console.log('User accepted incoming call');
            
            // Stop ringtone immediately
            stopRingtone();
            
            // Hide popup immediately (before accepting call)
            hideIncomingCallPopup();
            
            // Close notification if exists
            if (currentNotification) {
                currentNotification.close();
                currentNotification = null;
            }
            
            if (incomingCall) {
                try {
                    // Get caller info for widget
                    const callerNumber = incomingCall.parameters?.From || 'Tundmatu number';
                    const callerName = null; // Could be enhanced with contact lookup
                    
                    // Show outgoing call widget for accepted incoming call
                    showOutgoingCallWidget(callerNumber, callerName);
                    
                    // Update widget to show it's an incoming call that was accepted
                    const callTypeEl = document.getElementById('callTypeText');
                    if (callTypeEl) {
                        callTypeEl.textContent = 'Vastuv√µetud k√µne';
                    }
                    
                    // Accept the call
                    incomingCall.accept();
                    showStatus('üìû K√µne vastuv√µetud!', 'success');
                    
                    // Set widget status to connected immediately since call is already established
                    setTimeout(() => {
                        if (widgetCallStatus !== 'connected') {
                            widgetCallStatus = 'connected';
                            updateWidgetCallStatus();
                            startWidgetCallTimer();
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error accepting call:', error);
                    showStatus('‚ùå K√µne vastuv√µtmine eba√µnnestus: ' + error.message, 'error');
                    hideOutgoingCallWidget(); // Hide widget if error
                }
            } else {
                console.error('No incoming call to accept');
            }
        }

        function quickMessage() {
            console.log('Quick message button clicked');
            // TODO: Implement quick message functionality
            showStatus('üì± Kiire s√µnumi funktsioon tulekul...', 'info');
        }

        function declineIncomingCall() {
            console.log('User declined incoming call');
            
            // Stop ringtone immediately
            stopRingtone();
            
            // Hide popup immediately (before rejecting call)
            hideIncomingCallPopup();
            
            // Hide widget if it was shown
            hideOutgoingCallWidget();
            
            // Close notification if exists
            if (currentNotification) {
                currentNotification.close();
                currentNotification = null;
            }
            
            if (incomingCall) {
                try {
                    incomingCall.reject();
                    showStatus('üìµ K√µne tagasi l√ºkatud', 'info');
                } catch (error) {
                    console.error('Error declining call:', error);
                    showStatus('‚ùå K√µne tagasil√ºkkamine eba√µnnestus: ' + error.message, 'error');
                }
            }
            
            // Clear incoming call reference
            incomingCall = null;
        }

        function updateDeviceStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator ' + status;
            statusText.textContent = text;
        }

        function showStatus(message, type) {
            // Only log to console, no UI display for cleaner interface
            console.log(`Status [${type}]: ${message}`);
        }

        let volumeMonitoringInterval;

        function startVolumeMonitoring() {
            // This is a placeholder - actual volume monitoring would require access to the audio stream
            let volume = 0;
            volumeMonitoringInterval = setInterval(() => {
                // Simulate volume changes for demo
                volume = Math.random() * 100;
                document.getElementById('volumeLevel').style.width = volume + '%';
            }, 100);
        }

        function stopVolumeMonitoring() {
            if (volumeMonitoringInterval) {
                clearInterval(volumeMonitoringInterval);
                document.getElementById('volumeLevel').style.width = '0%';
            }
        }

        // Keyboard support
        document.addEventListener('keydown', function(event) {
            const key = event.key;
            
            // Check if incoming call popup is active
            const incomingPopup = document.getElementById('incomingCallPopup');
            if (incomingPopup.classList.contains('active')) {
                if (key === 'Enter' || key === ' ') {
                    event.preventDefault();
                    acceptIncomingCall();
                } else if (key === 'Escape') {
                    event.preventDefault();
                    declineIncomingCall();
                }
                return; // Don't process other keys when popup is active
            }
            
            // Global keyboard shortcuts
            if (key === 'Escape') {
                if (isDialerOpen) {
                    event.preventDefault();
                    closeDialer();
                }
                return;
            }
            
            // Open dialer with Ctrl+D or when typing numbers
            if ((event.ctrlKey && key === 'd') || (!isDialerOpen && key >= '0' && key <= '9')) {
                event.preventDefault();
                openDialer();
                if (key >= '0' && key <= '9') {
                    // Add the digit after opening dialer
                    setTimeout(() => addDigit(key), 100);
                }
                return;
            }
            
            // Dialer keyboard support (only when dialer is open)
            if (isDialerOpen) {
            if (key >= '0' && key <= '9') {
                addDigit(key);
            } else if (key === '*') {
                addDigit('*');
            } else if (key === '#') {
                addDigit('#');
            } else if (key === 'Backspace') {
                clearNumber();
            } else if (key === 'Enter') {
                makeCall();
                }
            }
        });

        // Outgoing Call Widget Management
        let outgoingCallWidget = null;
        let widgetCallStatus = 'connecting'; // connecting, ringing, connected
        let widgetCallDuration = 0;
        let widgetCallTimer = null;
        let widgetIsMuted = false;
        let widgetIsSpeakerOn = false;

        function showOutgoingCallWidget(phoneNumber, contactName = null) {
            console.log('üìû Showing outgoing call widget for:', phoneNumber);
            
            const widget = document.getElementById('outgoingCallWidget');
            const contactNameEl = document.getElementById('widgetContactName');
            const contactNumberEl = document.getElementById('widgetContactNumber');
            
            if (!widget) {
                console.error('‚ùå Outgoing call widget element not found!');
                return;
            }
            
            // Hide sticky button during call
            if (stickyCallBtn) {
                stickyCallBtn.hide();
            }
            
            // Update contact info
            contactNameEl.textContent = contactName || 'Tundmatu number';
            contactNumberEl.textContent = phoneNumber || '+372XXXXXXXX';
            
            // Reset widget state
            widgetCallStatus = 'connecting';
            widgetCallDuration = 0;
            widgetIsMuted = false;
            widgetIsSpeakerOn = false;
            
            // Update UI
            updateWidgetCallStatus();
            updateWidgetControls();
            
            // Show widget with animation
            widget.classList.add('show');
            
            // Simulate call progression after delay
            setTimeout(() => {
                if (widgetCallStatus === 'connecting') {
                    widgetCallStatus = 'ringing';
                    updateWidgetCallStatus();
                }
            }, 2000);
            
            // Simulate call being answered after another delay
            setTimeout(() => {
                if (widgetCallStatus === 'ringing') {
                    widgetCallStatus = 'connected';
                    updateWidgetCallStatus();
                    startWidgetCallTimer();
                }
            }, 4000);
            
            console.log('üìû Outgoing call widget shown');
        }

        function hideOutgoingCallWidget() {
            console.log('üìû Hiding outgoing call widget');
            
            const widget = document.getElementById('outgoingCallWidget');
            if (!widget) return;
            
            // Hide with animation
            widget.classList.remove('show');
            
            // Stop timer
            stopWidgetCallTimer();
            
            // Show sticky button again only if dialer is not open
            if (stickyCallBtn && !isDialerOpen) {
                stickyCallBtn.show();
            }
            
            console.log('üìû Outgoing call widget hidden');
        }

        function updateWidgetCallStatus() {
            const connectingEl = document.getElementById('statusConnecting');
            const ringingEl = document.getElementById('statusRinging');
            const connectedEl = document.getElementById('statusConnected');
            const timerEl = document.getElementById('widgetTimer');
            
            // Hide all status indicators
            connectingEl.classList.remove('active');
            ringingEl.classList.remove('active');
            connectedEl.classList.remove('active');
            
            // Show current status
            switch (widgetCallStatus) {
                case 'connecting':
                    connectingEl.classList.add('active');
                    timerEl.textContent = '√úhendamine...';
                    break;
                case 'ringing':
                    ringingEl.classList.add('active');
                    timerEl.textContent = 'Helistamine...';
                    break;
                case 'connected':
                    connectedEl.classList.add('active');
                    timerEl.textContent = formatWidgetDuration(widgetCallDuration);
                    break;
            }
        }

        function formatWidgetDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startWidgetCallTimer() {
            stopWidgetCallTimer(); // Clear any existing timer
            
            widgetCallTimer = setInterval(() => {
                widgetCallDuration++;
                
                const timerEl = document.getElementById('widgetTimer');
                if (timerEl && widgetCallStatus === 'connected') {
                    timerEl.textContent = formatWidgetDuration(widgetCallDuration);
                }
            }, 1000);
        }

        function stopWidgetCallTimer() {
            if (widgetCallTimer) {
                clearInterval(widgetCallTimer);
                widgetCallTimer = null;
            }
            widgetCallDuration = 0;
        }

        function updateWidgetControls() {
            const muteBtn = document.getElementById('widgetMuteBtn');
            const speakerBtn = document.getElementById('widgetSpeakerBtn');
            
            // Update mute button
            if (widgetIsMuted) {
                muteBtn.classList.add('muted');
                // Update SVG to muted microphone
                muteBtn.querySelector('svg').innerHTML = `
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                    <line x1="3" y1="3" x2="21" y2="21"/>
                `;
            } else {
                muteBtn.classList.remove('muted');
                // Update SVG to normal microphone
                muteBtn.querySelector('svg').innerHTML = `
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                `;
            }
            
            // Update speaker button
            if (widgetIsSpeakerOn) {
                speakerBtn.classList.add('speaker-on');
            } else {
                speakerBtn.classList.remove('speaker-on');
            }
        }

        function widgetToggleMute() {
            widgetIsMuted = !widgetIsMuted;
            updateWidgetControls();
            
            // Also toggle actual call mute if there's an active call
            if (currentCall) {
                currentCall.mute(widgetIsMuted);
            }
            
            console.log('üé§ Widget mute toggled:', widgetIsMuted);
            showStatus(widgetIsMuted ? 'Mikrofon v√§lja l√ºlitatud' : 'Mikrofon sisse l√ºlitatud', 'info');
        }

        function widgetToggleSpeaker() {
            widgetIsSpeakerOn = !widgetIsSpeakerOn;
            updateWidgetControls();
            
            console.log('üîä Widget speaker toggled:', widgetIsSpeakerOn);
            showStatus(widgetIsSpeakerOn ? 'K√µlar sisse l√ºlitatud' : 'K√µlar v√§lja l√ºlitatud', 'info');
        }

        function widgetHangupCall() {
            console.log('üìû Widget hangup call');
            
            // Hide widget
            hideOutgoingCallWidget();
            
            // Hangup actual call
            if (currentCall) {
                currentCall.disconnect();
            }
            
            showStatus('K√µne l√µpetatud', 'info');
        }

        // Override the existing toggleMute and toggleSpeaker functions to work with widget
        const originalToggleMute = toggleMute;
        const originalToggleSpeaker = toggleSpeaker;

        function toggleMute() {
            // If widget is visible, use widget functions
            const widget = document.getElementById('outgoingCallWidget');
            if (widget && widget.classList.contains('show')) {
                widgetToggleMute();
            } else {
                originalToggleMute();
            }
        }

        function toggleSpeaker() {
            // If widget is visible, use widget functions
            const widget = document.getElementById('outgoingCallWidget');
            if (widget && widget.classList.contains('show')) {
                widgetToggleSpeaker();
            } else {
                originalToggleSpeaker();
            }
        }

        // Override hangupCall to work with widget
        const originalHangupCall = hangupCall;

        function hangupCall() {
            // If widget is visible, use widget function
            const widget = document.getElementById('outgoingCallWidget');
            if (widget && widget.classList.contains('show')) {
                widgetHangupCall();
            } else {
                originalHangupCall();
            }
        }

        // Legacy audio settings functions - now delegate to audio settings component
        function toggleAudioSettings() {
            if (audioSettings) {
                audioSettings.toggle();
            } else {
                // Fallback for backward compatibility
                const deviceSelection = document.getElementById('deviceSelection');
                const toggle = document.querySelector('.audio-settings-toggle');
                
                if (deviceSelection && toggle) {
                    if (deviceSelection.classList.contains('expanded')) {
                        deviceSelection.classList.remove('expanded');
                        toggle.classList.remove('active');
                    } else {
                        deviceSelection.classList.add('expanded');
                        toggle.classList.add('active');
                    }
                }
            }
        }

        // Update device status indicators (small dots)
        function updateDeviceStatusIndicators() {
            if (audioSettings) {
                // This is now handled by the audio settings component
                audioSettings.updateDeviceStatusIndicators();
            } else {
                // Fallback for backward compatibility
                const micDot = document.getElementById('micStatusDot');
                const speakerDot = document.getElementById('speakerStatusDot');
                
                if (micDot) {
                    // Check if microphone is available and working
                    if (availableInputDevices && availableInputDevices.length > 0) {
                        micDot.classList.remove('error');
                        micDot.classList.add('connected');
                    } else {
                        micDot.classList.remove('connected');
                        micDot.classList.add('error');
                    }
                }
                
                if (speakerDot) {
                    // Check if speakers are available
                    if (availableOutputDevices && availableOutputDevices.length > 0) {
                        speakerDot.classList.remove('error');
                        speakerDot.classList.add('connected');
                    } else {
                        speakerDot.classList.remove('connected');
                        speakerDot.classList.add('error');
                    }
                }
            }
        }

        // Dialer state management
        let isDialerOpen = false;

        // Open dialer
        function openDialer() {
            const dialerContainer = document.getElementById('dialerContainer');
            const backdrop = document.getElementById('dialerBackdrop');
            
            isDialerOpen = true;
            dialerContainer.classList.add('open');
            backdrop.classList.add('active');
            
            if (stickyCallBtn) {
                stickyCallBtn.hide();
            }
        }

        // Close dialer
        function closeDialer() {
            const dialerContainer = document.getElementById('dialerContainer');
            const backdrop = document.getElementById('dialerBackdrop');
            const widget = document.getElementById('outgoingCallWidget');
            
            isDialerOpen = false;
            dialerContainer.classList.remove('open');
            backdrop.classList.remove('active');
            
            // Only show sticky button if call widget is not visible
            if (stickyCallBtn && (!widget || !widget.classList.contains('show'))) {
                stickyCallBtn.show();
            }
        }

        // DTMF tone generator will be available from dialer-panel component
        let dtmfGenerator = null;

        // Sample contacts database
        const sampleContacts = [
            {
                id: 1,
                name: 'Mart Tamm',
                phone: '+37256272798',
                avatar: 'MT',
                company: 'Tehnoloogia O√ú'
            },
            {
                id: 2,
                name: 'Liisa Kask',
                phone: '+37253456789',
                avatar: 'LK',
                company: 'Disain Stuudio'
            },
            {
                id: 3,
                name: 'Peeter Saar',
                phone: '+37251234567',
                avatar: 'PS',
                company: 'Konsultatsioonid AS'
            },
            {
                id: 4,
                name: 'Anna Mets',
                phone: '+37258765432',
                avatar: 'AM',
                company: 'Turundus & M√º√ºk'
            },
            {
                id: 5,
                name: 'Jaan Kuusk',
                phone: '+37255555555',
                avatar: 'JK',
                company: 'IT Lahendused'
            },
            {
                id: 6,
                name: 'Kati Lepp',
                phone: '+37254321098',
                avatar: 'KL',
                company: 'Raamatupidamine'
            }
        ];

        // Populate contacts table
        function populateContacts() {
            const contactsTable = document.getElementById('contactsTable');
            if (!contactsTable) return;

            contactsTable.innerHTML = '';

            sampleContacts.forEach(contact => {
                const contactRow = document.createElement('div');
                contactRow.className = 'contacts-table-row';
                
                contactRow.innerHTML = `
                    <div class="contact-table-avatar">${contact.avatar}</div>
                    <div class="contact-table-info">
                        <div class="contact-table-name">${contact.name}</div>
                        <div class="contact-table-company">${contact.company}</div>
                    </div>
                    <div class="contact-table-phone">${contact.phone}</div>
                    <button class="contact-table-call-btn" onclick="callContact('${contact.phone}', '${contact.name}')" title="Helista ${contact.name}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        Helista
                    </button>
                `;
                
                contactsTable.appendChild(contactRow);
            });

            console.log('üìû Contacts table populated:', sampleContacts.length, 'contacts');
        }

        // Call a contact directly
        function callContact(phoneNumber, contactName) {
            console.log('üìû Calling contact:', contactName, phoneNumber);
            
            if (currentCall) {
                showStatus('‚ùå K√µne on juba k√§imas!', 'error');
                return;
            }

            if (!device || device.state !== 'registered') {
                showStatus('‚ùå Voice SDK pole valmis! Oota registreerimist...', 'error');
                return;
            }

            try {
                showStatus(`üìû Helistamine kontaktile ${contactName}...`, 'info');
                
                // Close dialer when call starts
                closeDialer();
                
                // Show outgoing call widget with contact name
                showOutgoingCallWidget(phoneNumber, contactName);
                
                // Make call using Voice SDK 2.x
                makeCallToNumber(phoneNumber, contactName);
                
            } catch (error) {
                console.error('Error calling contact:', error);
                showStatus('‚ùå Kontaktile helistamine eba√µnnestus: ' + error.message, 'error');
                hideOutgoingCallWidget();
            }
        }

        // Enhanced makeCall function that can accept parameters
        async function makeCallToNumber(phoneNumber, contactName = null) {
            try {
                // Make call using Voice SDK 2.x
                currentCall = await device.connect({
                    params: {
                        To: phoneNumber
                    }
                });

                // Show call controls immediately
                showCallControls(true, phoneNumber);

                // Call event handlers
                currentCall.on('accept', function() {
                    console.log('Call accepted');
                    document.getElementById('callStatusText').textContent = '√úhendatud';
                    showStatus(`üìû K√µne √ºhendatud${contactName ? ' kontaktiga ' + contactName : ''}! R√§√§gi mikrofoniga.`, 'success');
                    
                    // Start call timer
                    startCallTimer();
                    
                    // Show volume indicator
                    document.getElementById('volumeIndicator').classList.add('active');
                    startVolumeMonitoring();
                });

                currentCall.on('disconnect', function() {
                    console.log('Call disconnected');
                    currentCall = null;
                    showCallControls(false);
                    // Don't hide widget immediately - let user see call ended status
                    showStatus('K√µne l√µpetatud', 'info');
                    
                    // Update widget to show call ended
                    const timerEl = document.getElementById('widgetTimer');
                    if (timerEl) {
                        timerEl.textContent = 'K√µne l√µpetatud';
                    }
                    
                    // Hide widget after 3 seconds
                    setTimeout(() => {
                        hideOutgoingCallWidget();
                    }, 3000);
                    
                    // Hide volume indicator
                    document.getElementById('volumeIndicator').classList.remove('active');
                    stopVolumeMonitoring();
                    stopCallTimer();
                });

                currentCall.on('reject', function() {
                    console.log('Call rejected');
                    currentCall = null;
                    showCallControls(false);
                    hideOutgoingCallWidget();
                    showStatus('K√µne tagasi l√ºkatud', 'error');
                });

                currentCall.on('error', function(error) {
                    console.error('Voice SDK call error:', error);
                    showStatus('‚ùå K√µne viga: ' + error.message, 'error');
                    currentCall = null;
                    showCallControls(false);
                    hideOutgoingCallWidget();
                });

                // Handle incoming calls UI
                currentCall.on('ringing', function() {
                    console.log('Call is ringing');
                    document.getElementById('callStatusText').textContent = 'Helistab...';
                });

                console.log('Call initiated to:', phoneNumber, contactName ? `(${contactName})` : '');

            } catch (error) {
                console.error('Voice SDK error:', error);
                showStatus('‚ùå Voice SDK viga: ' + error.message, 'error');
                throw error;
            }
        }

        // Initialize sticky call button component
        let stickyCallBtn = null;
        let dialerPanel = null;
        let audioSettings = null;
        
        function initializeStickyButton() {
            console.log('üîµ initializeStickyButton called');
            console.log('üîµ StickyCallButton class:', StickyCallButton);
            
            try {
                stickyCallBtn = new StickyCallButton({
                    text: 'Helista',
                    onClick: (event, instance) => {
                        console.log('üìû Sticky button clicked!');
                        openDialer();
                    }
                });
                
                console.log('üîµ stickyCallBtn created:', stickyCallBtn);
                console.log('üîµ Button element:', stickyCallBtn.element);
                console.log('üîµ Button hidden:', stickyCallBtn.isHidden);
                
                // Check if button is in DOM after a short delay
                setTimeout(() => {
                    const buttonInDOM = document.getElementById('stickyCallBtn');
                                    console.log('üîµ Button in DOM:', buttonInDOM);
                if (buttonInDOM) {
                    console.log('üîµ Button styles:', window.getComputedStyle(buttonInDOM));
                    console.log('üîµ Button visible:', buttonInDOM.offsetParent !== null);
                }
                
                // Make sure button is visible initially
                if (stickyCallBtn && stickyCallBtn.isHidden) {
                    console.log('üîµ Button was hidden, showing it...');
                    stickyCallBtn.show();
                }
            }, 500);
                
            } catch (error) {
                console.error('üî¥ Error in initializeStickyButton:', error);
                throw error;
            }
        }
        
        function initializeDialerPanel() {
            const container = document.getElementById('dialerPanelContainer');
            if (container) {
                dialerPanel = new DialerPanel({
                    container: container,
                    placeholder: 'Sisesta number',
                    onCall: (phoneNumber, instance) => {
                        // Use the main makeCall function logic
                        makeCallToNumber(phoneNumber);
                    },
                    onNumberChange: (number, instance) => {
                        // Update the global currentNumber variable for compatibility
                        currentNumber = number;
                    }
                });
            }
        }
        
        function initializeAudioSettings() {
            const container = document.getElementById('audioSettingsContainer');
            if (container) {
                audioSettings = new AudioSettings({
                    container: container,
                    title: 'Audio seaded',
                    collapsed: true,
                    twilioDevice: null, // Will be set later when device is ready
                    onDeviceChange: (deviceType, deviceId, instance) => {
                        console.log(`Device changed: ${deviceType} -> ${deviceId}`);
                    },
                    onToggle: (isExpanded, instance) => {
                        console.log(`Audio settings ${isExpanded ? 'expanded' : 'collapsed'}`);
                    }
                });
            }
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            console.log('=== PAGE LOADED ===');
            console.log('StickyCallButton available:', typeof StickyCallButton);
            console.log('DialerPanel available:', typeof DialerPanel);
            console.log('AudioSettings available:', typeof AudioSettings);
            
            try {
                initializeStickyButton();
                console.log('‚úÖ Sticky button initialized');
            } catch (error) {
                console.error('‚ùå Sticky button failed:', error);
            }
            
            try {
                initializeDialerPanel();
                console.log('‚úÖ Dialer panel initialized');
            } catch (error) {
                console.error('‚ùå Dialer panel failed:', error);
            }
            
            try {
                initializeAudioSettings();
                console.log('‚úÖ Audio settings initialized');
            } catch (error) {
                console.error('‚ùå Audio settings failed:', error);
            }
            
            try {
                initializeApp();
                console.log('‚úÖ App initialized');
            } catch (error) {
                console.error('‚ùå App initialization failed:', error);
            }
        });
    </script>
</body>
</html> 